let d=[];async function I(){try{const t=await(await fetch("/api/cities/european")).json();if(t.success)d=t.cities,window.citiesData=d;else throw new Error(t.message)}catch(a){console.warn("âš ï¸ Could not load cities data, using fallback",a),d=[{id:"amsterdam_nl",name:"Amsterdam",country:"NL",countryName:"Netherlands",coordinates:[4.8885,52.370216]},{id:"athens_gr",name:"Athens",country:"GR",countryName:"Greece",coordinates:[23.727539,37.98381]},{id:"barcelona_es",name:"Barcelona",country:"ES",countryName:"Spain",coordinates:[2.173403,41.385064]},{id:"berlin_de",name:"Berlin",country:"DE",countryName:"Germany",coordinates:[13.399602,52.523764]},{id:"brussels_be",name:"Brussels",country:"BE",countryName:"Belgium",coordinates:[4.35171,50.846557]},{id:"london_gb",name:"London",country:"GB",countryName:"United Kingdom",coordinates:[-.118667,51.50194]},{id:"madrid_es",name:"Madrid",country:"ES",countryName:"Spain",coordinates:[-3.70379,40.416775]},{id:"paris_fr",name:"Paris",country:"FR",countryName:"France",coordinates:[2.331389,48.868638]},{id:"rome_it",name:"Rome",country:"IT",countryName:"Italy",coordinates:[12.496366,41.902783]},{id:"toulouse_fr",name:"Toulouse",country:"FR",countryName:"France",coordinates:[1.444209,43.604652]},{id:"vienna_at",name:"Vienna",country:"AT",countryName:"Austria",coordinates:[16.363449,48.210033]},{id:"zurich_ch",name:"Zurich",country:"CH",countryName:"Switzerland",coordinates:[8.541694,47.376887]}],window.citiesData=d}}async function L(){await I();let a,t,c,v=10;for(;v>0&&(a=document.getElementById("country"),t=document.getElementById("city"),c=document.getElementById("city-suggestions"),!(a&&t&&c));)await new Promise(e=>setTimeout(e,100)),v--;if(!a||!t||!c){console.error("âŒ Required elements not found for CityCountryPicker");return}let l=d,s=-1;function C(){const e=a.value;if(e?l=d.filter(n=>n.country===e):l=d,t.value&&e&&!l.find(o=>o.name.toLowerCase()===t.value.toLowerCase())){t.value="";const o=document.getElementById("city-id"),i=document.getElementById("latitude"),r=document.getElementById("longitude");o&&(o.value=""),i&&(i.value=""),r&&(r.value=""),t.style.borderColor=""}u()}function E(e=""){const n=e.toLowerCase().trim();let o=l;if(n&&(o=l.filter(i=>i.name.toLowerCase().includes(n))),o=o.slice(0,8),o.length===0){u();return}c.innerHTML=o.map((i,r)=>`
        <div class="city-suggestion ${r===s?"selected":""}" data-index="${r}">
          <span class="city-name">${i.name}</span>
          <span class="country-flag">${h(i.country)}</span>
        </div>
      `).join(""),c.classList.remove("hidden"),c.querySelectorAll(".city-suggestion").forEach((i,r)=>{i.addEventListener("click",()=>y(o[r]))})}function u(){c.classList.add("hidden"),s=-1}function y(e){t.value=e.name,a.value||(a.value=e.country,C());const n=document.getElementById("city-id"),o=document.getElementById("latitude"),i=document.getElementById("longitude");n&&e.id&&(n.value=e.id),o&&e.coordinates&&(o.value=e.coordinates[1]),i&&e.coordinates&&(i.value=e.coordinates[0]),u(),t.blur()}function h(e){return{AT:"ðŸ‡¦ðŸ‡¹",BE:"ðŸ‡§ðŸ‡ª",CH:"ðŸ‡¨ðŸ‡­",CZ:"ðŸ‡¨ðŸ‡¿",DE:"ðŸ‡©ðŸ‡ª",DK:"ðŸ‡©ðŸ‡°",ES:"ðŸ‡ªðŸ‡¸",FI:"ðŸ‡«ðŸ‡®",FR:"ðŸ‡«ðŸ‡·",GB:"ðŸ‡¬ðŸ‡§",GR:"ðŸ‡¬ðŸ‡·",HU:"ðŸ‡­ðŸ‡º",IE:"ðŸ‡®ðŸ‡ª",IT:"ðŸ‡®ðŸ‡¹",NL:"ðŸ‡³ðŸ‡±",NO:"ðŸ‡³ðŸ‡´",PL:"ðŸ‡µðŸ‡±",PT:"ðŸ‡µðŸ‡¹",RO:"ðŸ‡·ðŸ‡´",SE:"ðŸ‡¸ðŸ‡ª"}[e]||"ðŸ™ï¸"}a.addEventListener("change",C),t.addEventListener("input",e=>{E(e.target.value)}),t.addEventListener("focus",e=>{E(e.target.value)}),t.addEventListener("blur",()=>{setTimeout(()=>{u(),p()},150)});function p(){const e=t.value.trim(),n=a.value;if(!e||!n)return;const o=document.getElementById("city-id"),i=document.getElementById("latitude"),r=document.getElementById("longitude");if(o?.value&&i?.value&&r?.value)return;const g=l.find(f=>f.name.toLowerCase()===e.toLowerCase());if(g){console.log("ðŸŽ¯ Auto-resolving city:",g),y(g),t.style.borderColor="#10b981",setTimeout(()=>{t.style.borderColor=""},2e3);return}const m=l.find(f=>f.name.toLowerCase().includes(e.toLowerCase())||e.toLowerCase().includes(f.name.toLowerCase()));if(m){console.log("ðŸŽ¯ Auto-resolving with partial match:",m),t.value=m.name,y(m),t.style.borderColor="#f59e0b",setTimeout(()=>{t.style.borderColor=""},2e3);return}console.warn("âš ï¸ Could not auto-resolve city:",e,"in country:",n),t.style.borderColor="#ef4444",setTimeout(()=>{t.style.borderColor=""},3e3)}t.addEventListener("keydown",e=>{const n=c.querySelectorAll(".city-suggestion");if(e.key==="ArrowDown")e.preventDefault(),s=Math.min(s+1,n.length-1),w();else if(e.key==="ArrowUp")e.preventDefault(),s=Math.max(s-1,-1),w();else if(e.key==="Enter"){if(e.preventDefault(),s>=0&&n[s]){const o=n[s].querySelector(".city-name").textContent,i=l.find(r=>r.name===o);i&&y(i)}}else e.key==="Escape"&&u()});function w(){c.querySelectorAll(".city-suggestion").forEach((e,n)=>{n===s?e.classList.add("selected"):e.classList.remove("selected")})}document.addEventListener("click",e=>{e.target.closest(".autocomplete-container")||u()})}document.addEventListener("DOMContentLoaded",L);document.addEventListener("astro:page-load",L);

---
import ArtistForm from './ArtistForm.astro';
import AuthModalForm from './AuthModalForm.astro';
import NewsletterModal from './NewsletterModal.astro';
import * as m from '../paraglide/messages.js';

// Get authentication state from Layout props
const { user, isAuthenticated } = Astro.props;
---

<!-- Newsletter Modal (global) -->
<NewsletterModal />

<!-- Dropdown Content -->
<div class="dropdown-content">
  <!-- Newsletter Button -->
  <button id="open-newsletter-btn" class="newsletter-cta-btn">
    Join the Newsletter
  </button>

  <h2 class="modal-title" id="form-modal-title">Join the map</h2>

  <!-- Form Content -->
      <!-- Auth Form (shown when not logged in) -->
      <div id="auth-section" class={isAuthenticated ? "hidden" : ""}>
        <div class="auth-intro">
        </div>
        <AuthModalForm />
      </div>

  <!-- Artist Form (shown when logged in AND no submission) -->
  <div id="artist-section" class={isAuthenticated ? "" : "hidden"}>
    <ArtistForm />
  </div>

  <!-- Logout Button (shown when logged in) -->
  <div id="logout-section" class={isAuthenticated ? "logout-container" : "hidden"}>
    <a href="/api/auth/logout" class="logout-link" id="modal-logout-btn">
      Logout
    </a>
  </div>
</div>


<style>
  .dropdown-content {
    padding: 20px;
    padding-bottom: 80px; /* Extra bottom padding for mobile scrolling */
    background: transparent;
    box-sizing: border-box;
  }

  .newsletter-cta-btn {
    display: block;
    width: 100%;
    padding: 1rem;
    margin-bottom: 2rem;
    background: white;
    color: black;
    border: 3px solid black;
    font-size: 1.25rem;
    font-weight: 700;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .newsletter-cta-btn:hover {
    background: black;
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  }

  .modal-title {
    text-align: center;
    font-size: 2rem;
    font-weight: 900;
    color: white;
    margin: 0 0 20px 0;
    text-transform: none;
    letter-spacing: normal;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .newsletter-cta-btn {
      font-size: 1rem;
      padding: 0.875rem;
      margin-bottom: 1.5rem;
    }

    .modal-title {
      font-size: 1.5rem;
    }
  }

  @media (max-width: 480px) {
    .newsletter-cta-btn {
      font-size: 0.9rem;
      padding: 0.75rem;
    }

    .modal-title {
      font-size: 1.25rem;
    }
  }

  .auth-intro {
    text-align: center;
    margin-bottom: 2rem;
    padding: 1rem;
    background: transparent;
    border: none;
  }

  .auth-intro p {
    color: black;
    font-weight: 500;
    font-size: 1rem;
    margin: 0;
    text-transform: none;
    letter-spacing: normal;
  }

  /* Logout Button Container */
  .logout-container {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-top: 2rem;
    padding: 1.5rem 0;
  }

  .logout-link {
    color: white;
    text-decoration: none;
    font-weight: 900;
    font-size: 1rem;
    padding: 0.75rem 2rem;
    border: 3px solid white;
    border-radius: 0;
    transition: all 0.2s ease;
    white-space: nowrap;
    text-transform: uppercase;
    letter-spacing: 1px;
    position: relative;
    background: transparent;
    display: inline-block;
  }

  .logout-link:hover {
    background: white;
    color: black;
    transform: translateX(-2px) translateY(-2px);
    box-shadow: 4px 4px 0px rgba(255, 255, 255, 0.3);
  }

  .logout-link:active {
    transform: translateX(0) translateY(0);
    box-shadow: none;
  }

  /* Form styling to match the design */
  :global(.artist-form-container) {
    background: transparent !important;
    padding: 0 !important;
    margin: 0 !important;
    box-sizing: border-box !important;
  }

  :global(.artist-form) {
    background: transparent !important;
  }

  :global(.auth-modal-container) {
    background: transparent !important;
  }

  :global(.form-group) {
    margin-bottom: 20px !important;
  }

  :global(.form-group label) {
    display: block;
    margin-bottom: 8px;
    font-weight: 700;
    color: black;
    font-size: 14px;
    text-transform: uppercase;
  }

  :global(.form-group input),
  :global(.form-group select),
  :global(.form-group textarea) {
    width: 100%;
    padding: 10px 12px;
    border: 2px solid black;
    background: transparent;
    font-size: 14px;
    color: white;
    font-weight: 700;
    border-radius: 0;
    transition: all 0.2s ease;
  }

  :global(.form-group input:focus),
  :global(.form-group select:focus),
  :global(.form-group textarea:focus) {
    outline: none;
    background: transparent;
  }

  :global(.form-group input::placeholder),
  :global(.form-group textarea::placeholder) {
    color: rgba(255, 255, 255, 0.7);
    font-weight: 700;
  }

  /* Submit button styling */
  :global(.submit-btn) {
    background: none;
    border: none;
    padding: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    margin: 15px auto;
    display: block;
    width: auto;
  }

  :global(.submit-btn:hover) {
    opacity: 0.7;
  }

  :global(.submit-btn img) {
    width: auto;
    height: 40px;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .dropdown-content {
      padding: 15px 20px;
      padding-bottom: 100px; /* Extra bottom padding for mobile scrolling */
      box-sizing: border-box;
    }

    .modal-title {
      font-size: 1.5rem;
      margin: 0 0 15px 0;
    }

    :global(.form-group input),
    :global(.form-group select),
    :global(.form-group textarea) {
      box-sizing: border-box;
    }

    .logout-container {
      margin-top: 1.5rem;
      padding: 1rem 0;
    }

    .logout-link {
      font-size: 0.85rem;
      padding: 0.625rem 1.5rem;
      border-width: 2px;
      letter-spacing: 0.5px;
    }

    .logout-link:hover {
      transform: translateX(-1px) translateY(-1px);
      box-shadow: 2px 2px 0px rgba(255, 255, 255, 0.3);
    }
  }

  @media (max-width: 480px) {
    .logout-link {
      font-size: 0.75rem;
      padding: 0.5rem 1rem;
      border-width: 2px;
      letter-spacing: 0.25px;
    }

    .logout-link:hover {
      transform: translateX(-1px) translateY(-1px);
      box-shadow: 2px 2px 0px rgba(255, 255, 255, 0.2);
    }
  }
</style>

<script>
  // Check if user has already submitted a form
  async function checkUserSubmission() {
    try {
      // Get Directus URL from environment or use default
      const directusUrl = 'https://directus-production-1f5c.up.railway.app';

      // Get token from cookie
      const token = document.cookie
        .split('; ')
        .find(row => row.startsWith('directus_session_token='))
        ?.split('=')[1];

      if (!token) {
        console.log('⚠️ No authentication token found');
        return false;
      }

      const response = await fetch(`${directusUrl}/check-submission`, {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });

      if (!response.ok) {
        console.log('⚠️ Could not check submission status');
        return false;
      }

      const data = await response.json();
      return data.hasSubmission === true;
    } catch (error) {
      console.error('Error checking submission:', error);
      return false;
    }
  }

  async function handleAuthSuccess() {
    const authSection = document.getElementById('auth-section');
    const artistSection = document.getElementById('artist-section');
    const logoutSection = document.getElementById('logout-section');

    if (authSection && artistSection) {
      authSection.classList.add('hidden');

      // Show logout button
      if (logoutSection) {
        logoutSection.classList.remove('hidden');
        logoutSection.classList.add('logout-container');
      }

      // Always show the artist form when authenticated
      // The form will auto-fill if user has existing data (handled by loadExistingSubmission)
      artistSection.classList.remove('hidden');
    }
  }

  // Check submission status on page load if user is authenticated
  async function checkSubmissionOnLoad() {
    const authSection = document.getElementById('auth-section');
    const artistSection = document.getElementById('artist-section');

    // Only check if auth section is hidden (user is logged in)
    if (authSection && authSection.classList.contains('hidden')) {
      // Always show the artist form when authenticated
      // The form will auto-fill if user has existing data (handled by loadExistingSubmission)
      artistSection?.classList.remove('hidden');
    }
  }

  // Listen for auth success event
  window.addEventListener('authSuccess', handleAuthSuccess);

  // Newsletter button handler
  function initNewsletterButton() {
    const newsletterBtn = document.getElementById('open-newsletter-btn');
    if (newsletterBtn) {
      newsletterBtn.addEventListener('click', () => {
        if (window.openNewsletterModal) {
          window.openNewsletterModal();
        }
      });
    }
  }

  // Initialize on DOM loaded
  document.addEventListener('DOMContentLoaded', () => {
    window.addEventListener('authSuccess', handleAuthSuccess);
    initNewsletterButton();
    checkSubmissionOnLoad();
  });

  // Handle case where script loads after DOM
  if (document.readyState !== 'loading') {
    window.addEventListener('authSuccess', handleAuthSuccess);
    initNewsletterButton();
    checkSubmissionOnLoad();
  }

  // Re-initialize on Astro page transitions
  document.addEventListener('astro:page-load', () => {
    initNewsletterButton();
    checkSubmissionOnLoad();
  });
</script>